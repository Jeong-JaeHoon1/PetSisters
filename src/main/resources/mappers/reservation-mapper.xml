<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="reservationMapper">

	<resultMap id="reservationResultSet" type="reservation">
		<result column="RES_NO" property="resNo" />
		<result column="START_DATE" property="startDate" />
		<result column="END_DATE" property="endDate" />
		<result column="REGISTER_DATE" property="registerDate" />
		<result column="CONTENT" property="content" />
		<result column="STATUS" property="status" />
		<result column="USER_NO" property="userNo" />
		<result column="REF_PNO" property="refPno" />
		<result column="CA_STATUS" property="caStatus" />
		<result column="P_TITLE" property="ptitle" />
		<result column="CARE_LIST" property="pcareList" />
		<result column="P_NO" property="pno" />
		<result column="FILE_PATH" property="petFile" />
		<result column="ADDRESS" property="address" />
		<result column="ORIGIN_NAME" property="originName" />
		<result column="REVIEW_COUNT" property="reviewCount" />
		<result column="REVIEW_STATUS" property="checkReview" />
	</resultMap>
	
	<!-- 예약 리스트 총 갯수 구하는 쿼리문 -->
	<select id="selectListCount" resultType="_int">
	SELECT COUNT(*) 
	  FROM RESERVATION
	 WHERE USER_NO = #{userNo} 
	</select>
	
	
	<!-- 예약 리스트 구하는 쿼리문 -->
	<select id="selectPetsitterList" resultMap="reservationResultSet">
		SELECT R.START_DATE,
		       R.END_DATE,
		       M.ADDRESS,
		       M.CA_STATUS,
		       P.P_TITLE,
		       P.CARE_LIST,
		       P.P_NO,
		       A.FILE_PATH AS FILE_PATH,
		       A.ORIGIN_NAME,
		       (SELECT COUNT(*) FROM REVIEW WHERE REF_RESNO = R.RES_NO) AS REVIEW_COUNT,
		        CASE WHEN REV.REV_NO IS NOT NULL THEN 1 ELSE 0 END AS REVIEW_STATUS
		FROM RESERVATION R
		JOIN MEMBER M ON R.USER_NO = M.USER_NO
		JOIN PETSITTER P ON R.REF_PNO = P.P_NO
		JOIN P_ATTACHMENT A ON P.P_NO = A.REF_PNO
		LEFT JOIN REVIEW REV ON R.RES_NO = REV.REF_RESNO
		WHERE R.USER_NO = #{userNo}
		ORDER BY R.START_DATE DESC
	</select>	

	
</mapper>













