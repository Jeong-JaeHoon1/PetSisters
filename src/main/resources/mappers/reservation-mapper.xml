<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="reservationMapper">

	<resultMap id="reservationResultSet" type="reservation">
		<result column="RES_NO" property="resNo" />
		<result column="START_DATE" property="startDate" />
		<result column="END_DATE" property="endDate" />
		<result column="REGISTER_DATE" property="registerDate" />
		<result column="CONTENT" property="content" />
		<result column="STATUS" property="status" />
		<result column="USER_NO" property="userNo" />
		<result column="REF_PNO" property="refPno" />
		<result column="CA_STATUS" property="caStatus" />
		<result column="P_TITLE" property="ptitle" />
		<result column="CARE_LIST" property="pcareList" />
		<result column="P_NO" property="pno" />
		<result column="FILE_PATH" property="petFile" />
		<result column="ADDRESS" property="address" />
		<result column="ORIGIN_NAME" property="originName" />
		<result column="REVIEW_COUNT" property="reviewCount" />
		<result column="REVIEW_STATUS" property="checkReview" />
	</resultMap>
	
	<resultMap id="reviewResultSet" type="review">
		<result column="REV_NO" property="revNo" />
		<result column="REV_TITLE" property="revTitle" />
		<result column="REV_CONTENT" property="revContent" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="A_CONTENT" property="acontent" />
		<result column="A_DATE" property="adate" />
		<result column="STATUS" property="status" />
		<result column="FILE_PATH" property="filePath" />
		<result column="REF_RESNO" property="refResNo" />
		<result column="CHANGE_NAME" property="changeName" />
		<result column="START_DATE" property="revStartDate" />
		<result column="END_DATE" property="revEndDate" />
	</resultMap>
	
	<!-- 예약 리스트 총 갯수 구하는 쿼리문 -->
	<select id="selectListCount" resultType="_int">
	SELECT COUNT(*) 
	  FROM RESERVATION
	 WHERE USER_NO = #{userNo} 
	</select>
	
	
	<!-- 예약 리스트 구하는 쿼리문 -->
	<select id="selectPetsitterList" resultMap="reservationResultSet">
		SELECT R.RES_NO,
			   R.START_DATE,
		       R.END_DATE,
		       M.ADDRESS,
		       M.CA_STATUS,
		       P.P_TITLE,
		       P.CARE_LIST,
		       P.P_NO,
		       A.FILE_PATH AS FILE_PATH,
		       A.ORIGIN_NAME,
		       (SELECT COUNT(*) FROM REVIEW WHERE REF_RESNO = R.RES_NO) AS REVIEW_COUNT,
		        CASE WHEN REV.REV_NO IS NOT NULL THEN 1 ELSE 0 END AS REVIEW_STATUS
		FROM RESERVATION R
		JOIN MEMBER M ON R.USER_NO = M.USER_NO
		JOIN PETSITTER P ON R.REF_PNO = P.P_NO
		LEFT JOIN P_ATTACHMENT A ON P.P_NO = A.REF_PNO
		LEFT JOIN REVIEW REV ON R.RES_NO = REV.REF_RESNO
	   WHERE R.USER_NO = #{userNo}
		 AND R.STATUS = 'Y' 
	   ORDER BY R.START_DATE DESC
	</select>	
	
	
	<!-- 후기 작성폼 초기 정보 조회용 쿼리문 -->
	<select id="selectReview" resultMap="reservationResultSet">
		SELECT * 
		FROM
		RESERVATION
		WHERE RES_NO = #{writeReviewNo}
	</select>

	
	<!-- 후기 작성용 쿼리문 -->
	<insert id="insertReview" parameterType="review">
		INSERT INTO REVIEW(REV_NO,
		                   REV_TITLE,
		                   REV_CONTENT,
		                   CREATE_DATE,
		                   STATUS,
		                   FILE_PATH,
		                   REF_RESNO)
					VALUES(SEQ_REVIEW.NEXTVAL,
					       #{revTitle},
					       #{revContent},
					       SYSDATE,
					       DEFAULT,
					       #{filePath},
					       #{rNo})
	</insert>
	
	
	<!-- 후기작성 초기 정보 불러오는 쿼리문 -->
	<select id="updateReview" parameterType="_int" resultMap="reviewResultSet">
		SELECT REV_TITLE, REV_CONTENT, FILE_PATH, REF_RESNO, START_DATE, END_DATE
		  FROM REVIEW 
		  JOIN RESERVATION ON RES_NO = REF_RESNO
		 WHERE REF_RESNO = #{rNo}	
	</select>
	
	
	<!-- 후기 수정 업데이트용 쿼리문 -->
	<update id="updateForm" parameterType="review">
		UPDATE REVIEW
		   SET REV_TITLE = #{revTitle},
		       REV_CONTENT = #{revContent},
		       CREATE_DATE = SYSDATE,
		       FILE_PATH = #{filePath}
		 WHERE REF_RESNO = #{rNo}
		   AND STATUS = 'Y'	
	</update>
	
	
	<!-- 예약 리스트 삭제용 쿼리문 -->
	<update id="deleteReservation" parameterType="_int">
		UPDATE RESERVATION   
		   SET STATUS = 'N'
		 WHERE RES_NO = #{rNo}
	</update>
	
	
</mapper>













